groups:
  - name: realtime-board-alerts
    rules:
      - alert: HighErrorRate
        expr: |
          (
            sum(rate({job="realtime-board"} |= "Request completed" | json status="fields.status" | status >= 500 [5m]))
            / sum(rate({job="realtime-board"} |= "Request completed" [5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate above 1% for 5 minutes"

      - alert: SlowRequests
        expr: |
          quantile_over_time(
            0.95,
            {job="realtime-board"} |= "Request completed"
            | json latency_ms="fields.latency_ms"
            | unwrap latency_ms [5m]
          ) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow HTTP requests"
          description: "P95 latency above 1000ms for 5 minutes"

      - alert: WebSocketDisconnects
        expr: |
          sum(rate({job="realtime-board"} |= "WebSocket disconnected" [5m])) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High WebSocket disconnect rate"
          description: "More than 10 disconnects per minute (5m window)"

      - alert: DatabaseSlow
        expr: |
          quantile_over_time(
            0.95,
            {job="realtime-board"} |= "Query executed successfully"
            | json latency_ms="fields.latency_ms"
            | unwrap latency_ms [5m]
          ) > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries"
          description: "P95 query latency above 500ms for 5 minutes"

      - alert: AuthenticationFailures
        expr: |
          sum(rate({job="realtime-board"} |~ "LoginFailed" [5m])) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "More than 50 login failures per 5 minutes"
